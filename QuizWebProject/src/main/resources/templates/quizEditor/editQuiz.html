<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Edit Quiz</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; gap: 2rem; padding: 2rem; }
        .sidebar { width: 200px; }
        .question-index { list-style: none; padding: 0; }
        .question-index li { margin-bottom: 0.5rem; }
        .question-index a { text-decoration: none; color: blue; }
        .main { flex: 1; }
        .field-group { margin-bottom: 1rem; }
        .optional-field { margin-bottom: 1rem; }
    </style>
    <script>
        function toggleFields() {
            const type = document.getElementById("questionType").value;
            document.querySelectorAll('.optional-field').forEach(div => div.style.display = 'none');

            if (type === "TestQuestion") {
                document.getElementById("possibleAnswersDiv").style.display = "block";
            }
            else if (type === "ResponseQuestion") {
                document.getElementById("orderedCheckboxDiv").style.display = "block";
            }
            else if (type === "PictureResponseQuestion") {
                document.getElementById("imageUrlDiv").style.display = "block";
            }
            else if (type === "MatchingQuestion") {
                document.getElementById("matchingLeftItemsDiv").style.display = "block";
                document.getElementById("matchingRightItemsDiv").style.display = "block";
            }
            else if (type === "AutoGeneratedQuestion") {
                document.getElementById("autoGenRangeDiv").style.display = "block";
            }

            const manualAnswerTypes = [
                "TestQuestion",
                "ResponseQuestion",
                "FillBlankQuestion",
                "PictureResponseQuestion"
            ];
            if (manualAnswerTypes.includes(type)) {
                document.getElementById("correctAnswerDiv").style.display = "block";
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            toggleFields();
            document.getElementById("questionType").addEventListener("change", toggleFields);
        });
    </script>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <h3>Questions</h3>
    <ul class="question-index" th:if="${currentMaxQuestions > 0}">
        <li th:each="i : ${#numbers.sequence(0, currentMaxQuestions - 1)}">
            <a th:href="@{/editQuiz/{id}/question/{idx}(id=${id},idx=${i})}">
                Question <span th:text="${i + 1}">1</span>
            </a>
        </li>
        <li>
            <a th:href="@{/editQuiz/{id}/question/{idx}(id=${id},idx=${currentMaxQuestions})}">
                ➕ Add New Question
            </a>
        </li>
    </ul>
    <div th:if="${currentMaxQuestions == 0}">
        <p>No questions yet.</p>
        <a th:href="@{/editQuiz/{id}/question/{idx}(id=${id},idx=0)}">
            ➕ Add Your First Question
        </a>
    </div>
</div>

<!-- Main Panel -->
<div class="main" th:with="newQuestion=${index == currentMaxQuestions}">
    <h2 th:text="${newQuestion} ? 'Add New Question' : 'Edit Question ' + (index + 1)">Edit Question</h2>

    <form th:action="@{/editQuiz/{id}/question/{idx}(id=${id},idx=${index})}" method="post">

        <!-- Question Text -->
        <div class="field-group">
            <label for="questionText">Question Text:</label><br>
            <input type="text" id="questionText" name="questionText" required
                   th:value="${question != null} ? ${question.question} : ''"/>
        </div>

        <!-- Question Type -->
        <div class="field-group">
            <label for="questionType">Question Type:</label><br>
            <select id="questionType" name="questionType" required>
                <option value="TestQuestion"
                        th:selected="${question?.questionType == 'TestQuestion'}">TestQuestion</option>
                <option value="ResponseQuestion"
                        th:selected="${question?.questionType == 'ResponseQuestion'}">ResponseQuestion</option>
                <option value="FillBlankQuestion"
                        th:selected="${question?.questionType == 'FillBlankQuestion'}">FillBlankQuestion</option>
                <option value="PictureResponseQuestion"
                        th:selected="${question?.questionType == 'PictureResponseQuestion'}">PictureResponseQuestion</option>
                <option value="MatchingQuestion"
                        th:selected="${question?.questionType == 'MatchingQuestion'}">MatchingQuestion</option>
                <option value="AutoGeneratedQuestion"
                        th:selected="${question?.questionType == 'AutoGeneratedQuestion'}">AutoGeneratedQuestion</option>
            </select>
        </div>

        <!-- TestQuestion -->
        <div id="possibleAnswersDiv" class="optional-field" style="display:none;"
             th:if="${question == null or question.questionType == 'TestQuestion'}">
            <label for="possibleAnswers">Possible Answers (comma-separated):</label><br>
            <input type="text" id="possibleAnswers" name="possibleAnswers"
                   th:value="${question != null and question.questionType == 'TestQuestion'} ? ${question.savAnswers} : ''"/>
        </div>

        <!-- ResponseQuestion -->
        <div id="orderedCheckboxDiv" class="optional-field" style="display:none;"
             th:if="${question == null or question.questionType == 'ResponseQuestion'}">
            <label>
                <input type="checkbox" id="ordered" name="ordered"
                       th:checked="${ (question != null and question.questionType == 'ResponseQuestion') ? question.answerOrdered : false }"/>
                Ordered
            </label>
        </div>

        <!-- PictureResponseQuestion -->
        <div id="imageUrlDiv" class="optional-field" style="display:none;"
             th:if="${question == null or question.questionType == 'PictureResponseQuestion'}">
            <label for="imageURL">Image URL:</label><br>
            <input type="text" id="imageURL" name="imageURL"
                   th:value="${question != null and question.questionType == 'PictureResponseQuestion'} ? ${question.imageUrl} : ''"/>
        </div>

        <!-- MatchingQuestion -->
        <div id="matchingLeftItemsDiv" class="optional-field" style="display:none;"
             th:if="${question == null or question.questionType == 'MatchingQuestion'}">
            <label for="leftItems">Left Items (comma-separated):</label><br>
            <input type="text" id="leftItems" name="leftItems"
                   th:value="${question != null and question.questionType == 'MatchingQuestion'} ? ${#strings.listJoin(question.leftItems, ',')} : ''"/>
        </div>
        <div id="matchingRightItemsDiv" class="optional-field" style="display:none;"
             th:if="${question == null or question.questionType == 'MatchingQuestion'}">
            <label for="rightItems">Right Items (comma-separated):</label><br>
            <input type="text" id="rightItems" name="rightItems"
                   th:value="${question != null and question.questionType == 'MatchingQuestion'} ? ${#strings.listJoin(question.rightItems, ',')} : ''"/>
        </div>

        <!-- AutoGeneratedQuestion -->
        <div id="autoGenRangeDiv" class="optional-field" style="display:none;"
             th:if="${question == null or question.questionType == 'AutoGeneratedQuestion'}">
            <label for="min">Operand Min:</label><br>
            <input type="number" id="min" name="min" min="0"
                   th:value="${min}"/><br>
            <label for="max">Operand Max:</label><br>
            <input type="number" id="max" name="max" min="0"
                   th:value="${max}"/>
        </div>

        <!-- Correct Answer(s) -->
        <div id="correctAnswerDiv" class="field-group optional-field" style="display:none;">
            <label for="correctAnswer">Correct Answer(s):</label><br>
            <input type="text" id="correctAnswer" name="correctAnswer"
                   th:value="${question != null} ? ${#strings.listJoin(question.correctAnswers, ',')} : ''"/>
        </div>

        <!-- Category -->
        <div class="field-group">
            <label for="category">Category:</label><br>
            <input type="text" id="category" name="category" required
                   th:value="${question?.category}"/>
        </div>

        <!-- Max Points -->
        <div class="field-group">
            <label for="maxPoints">Max Points:</label><br>
            <input type="number" id="maxPoints" name="maxPoints" min="1" required
                   th:value="${question?.maxPoints}"/>
        </div>

        <!-- Submit -->
        <button type="submit"
                th:text="${newQuestion} ? 'Add Question' : 'Save Question'">Save Question</button>
    </form>

    <!-- Navigation / Delete / Finish -->
    <div style="margin-top:1rem;">
        <p th:if="${!hasPrev and !hasNext and !newQuestion}">This is the only question.</p>
        <p th:if="${newQuestion}">Adding a new question.</p>
    </div>
    <div style="margin-top:0.5rem;">
        <form th:if="${hasPrev}" th:action="@{/editQuiz/{id}/question/{idx}(id=${id},idx=${index - 1})}" method="get" style="display:inline;">
            <button type="submit">Previous</button>
        </form>
        <form th:if="${hasNext}" th:action="@{/editQuiz/{id}/question/{idx}(id=${id},idx=${index + 1})}" method="get" style="display:inline;">
            <button type="submit">Next</button>
        </form>
    </div>
    <form th:if="${!newQuestion}" th:action="@{/editQuiz/{id}/question/{idx}/removeQuestion(id=${id},idx=${index})}" method="post" style="margin-top:1rem;">
        <button type="submit" style="color:red;">Delete This Question</button>
    </form>
    <form th:action="@{/homepage}" method="get" style="margin-top:1rem;">
        <button type="submit">Finish Editing</button>
    </form>
</div>

</body>
</html>
